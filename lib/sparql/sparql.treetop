# sparql.treetop

grammar Sparql
	include Primitives
	include Variables
	include LogicalExpressions
	include Graph
	include Series
	
	# 	'SELECT ?v WHERE { ?v ?p "cat"@en }'

	rule query
	   prologue space query_part:( select_query / construct_query / describe_query / ask_query ) {
		def well_formed?
			true #=> if a node has been identified as a query, it's well-formed by definition.
		end
	}
	end
	
	rule prologue
		base_decl? prefix_decl*
	end
	
	rule base_decl
		'BASE' space iri_ref
	end
	
	rule prefix_decl
		'PREFIX' space pname_ns space iri_ref
	end
	
	rule select_query
	   'SELECT' space (( 'DISTINCT' / 'REDUCED' ) space)? ( series_of_variables / '*' ) space series_of_dataset_clauses? space where space solution_modifier {
		def query_type
			"SELECT"
		end
	}
	end
	
	rule ask_query
		'ASK' space (series_of_dataset_clauses space)? where {
			def query_type
				"ASK"
			end
		}
	end
	
	rule describe_query
		'DESCRIBE' space ( series_of_var_or_irirefs / '*' ) space (series_of_dataset_clauses space)? (where space)? solution_modifier {
			def query_type
				"DESCRIBE"
			end
		}
	end
	
	rule construct_query
		'CONSTRUCT' space construct_template space (dataset_clause space)* (where space) solution_modifier {
			def query_type
				"CONSTRUCT"
			end
		}
	end
	
	rule where
		('WHERE' space)? group_graph_pattern
	end
	
	rule construct_template
		'{' space construct_triples? space '}'
	end
	
	rule construct_triples
		triples_same_subject space ( '.' construct_triples? )?
	end
	
	rule object_list
		object (',' space object)*
	end

	rule solution_modifier
		(order_clause? space limit_offset_clauses?) / order_clause? / limit_offset_clauses?
	end
	
	rule order_clause
		'ORDER BY' space series_of_order_conditions
	end
	
	rule offset_clause
		'OFFSET' space integer
	end

	rule limit_clause
		'LIMIT' space integer
	end
	
	rule limit_offset_clauses
		( limit_clause space (offset_clause? / offset_clause space limit_clause?) )
	end
	
	rule order_condition
		( ( 'ASC' / 'DESC' ) space bracketted_expression ) / ( constraint / var )
	end
	
	rule constraint
		bracketted_expression / built_in_call / function_call
	end
	
	rule built_in_call
		 'STR' space '(' expression ')' 
		/ 'LANG' space '(' expression ')' 
		/ 'LANGMATCHES' space '(' expression ',' expression ')' 
		/ 'DATATYPE' space '(' expression ')' / 'BOUND' space '(' var ')'
		/ 'sameTerm' '(' expression ',' expression ')'
		/ 'isIRI' space '(' expression ')'
		/ 'isURI' space '(' expression ')'
		/ 'isBLANK' space '(' expression ')'
		/ 'isLITERAL' space '(' expression ')'
		/ regex_expression
	end
	
	rule regex_expression
		'REGEX' space '(' expression ',' expression ( ',' expression )? ')'
	end
	
	rule function_call
		iriref arg_list
	end
	
	rule filter
		'FILTER' space constraint
	end
	
	rule dataset_clause
		'FROM' space ( default_graph_clause / named_graph_clause )
	end
	
	rule default_graph_clause
		source_selector
	end
	
	rule source_selector
		iriref
	end
	
	rule named_graph_clause
	 	'NAMED' space SourceSelector
	end
	
end
